name: ${COMPOSE_PROJECT_NAME:-calq-mcp}

services:
  calq:
    build: .
    ports:
      - "${MCP_PORT:-3000}:${MCP_PORT:-3000}"
    environment:
      - MCP_PORT=${MCP_PORT:-3000}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - CHROMA_URL=http://chromadb:8000
      - BASE_URL=${BASE_URL:-http://localhost:${MCP_PORT:-3000}}
    volumes:
      - calq-data:/data
    depends_on:
      chromadb:
        condition: service_healthy
    restart: unless-stopped

  chromadb:
    image: chromadb/chroma:latest
    ports:
      - "${CHROMA_PORT:-8000}:8000"
    volumes:
      - chroma-data:/chroma/chroma
    environment:
      - ANONYMIZED_TELEMETRY=false
      - ALLOW_RESET=false
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/heartbeat')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  calq-data:
  chroma-data:
